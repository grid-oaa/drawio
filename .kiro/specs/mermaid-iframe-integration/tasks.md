# 实现计划：Mermaid iframe 集成

## 概述

本实现计划将 Mermaid iframe 集成功能分解为一系列增量式的编码任务。每个任务都建立在前一个任务的基础上，最终实现完整的功能。所有任务都涉及编写、修改或测试代码。

## 任务

- [x] 1. 设置测试框架和基础结构
  - 安装 Jest 测试框架
  - 安装 fast-check 用于基于属性的测试
  - 创建测试配置文件
  - 创建测试辅助函数和 mock 对象
  - _需求：8.1, 8.2_

- [x] 2. 实现消息验证器
  - [x] 2.1 实现基础消息格式验证
    - 编写 `validateMessage` 函数
    - 验证必需字段（action, mermaid）
    - 验证字段类型
    - _需求：1.1, 1.4, 5.1_

  - [x] 2.2 编写消息格式验证的属性测试

    - **属性 1：有效消息接受**
    - **验证：需求 1.1, 5.1**

  - [x] 2.3 实现空值和空白字符串验证
    - 检查 mermaid 字段是否为空或仅包含空白
    - 返回 EMPTY_MERMAID 错误
    - _需求：1.2_

  - [x] 2.4 编写空值验证的属性测试

    - **属性 2：无效输入拒绝**
    - **验证：需求 1.2, 1.4**

  - [x] 2.5 实现 origin 安全验证
    - 编写 `isOriginAllowed` 函数
    - 检查 evt.origin 是否在允许列表中
    - 支持配置允许的 origin 列表
    - _需求：1.3, 6.1, 6.2, 6.3_

  - [x] 2.6 编写 origin 验证的属性测试

    - **属性 3：Origin 安全验证**
    - **验证：需求 1.3, 6.1, 6.2, 6.3**

  - [x] 2.7 实现消息大小限制
    - 检查消息大小是否超过 1MB
    - 返回 SIZE_EXCEEDED 错误
    - _需求：6.5_

  - [x] 2.8 编写消息大小限制的属性测试

    - **属性 4：消息大小限制**
    - **验证：需求 6.5**

  - [x] 2.9 实现 XSS 防护
    - 编写 `containsXSS` 函数
    - 检测 <script> 标签、javascript: 协议、事件处理器
    - 返回 XSS_DETECTED 错误
    - _需求：6.4_

  - [x] 2.10 编写 XSS 防护的属性测试

    - **属性 5：XSS 防护**
    - **验证：需求 6.4**


- [x] 3. 实现响应发送器
  - [x] 3.1 实现 sendResponse 函数
    - 构造响应消息对象
    - 使用 evt.source.postMessage 发送响应
    - 处理 postMessage 异常
    - _需求：4.1, 4.2, 4.3, 5.3_

  - [x] 3.2 编写成功响应格式的属性测试

    - **属性 13：成功响应格式**
    - **验证：需求 4.1, 5.3**

  - [x] 3.3 编写错误响应格式的属性测试

    - **属性 14：错误响应格式**
    - **验证：需求 4.2, 4.4, 5.3**

  - [x] 3.4 编写响应目标正确性的属性测试

    - **属性 15：响应目标正确**
    - **验证：需求 4.3**

- [x] 4. 实现日志记录功能
  - [x] 4.1 实现 log 函数
    - 支持不同日志级别（error, warn, info, debug）
    - 支持调试模式开关
    - 格式化日志消息（时间戳、级别、消息、上下文）
    - _需求：7.1, 7.2, 7.3_

  - [x] 4.2 编写日志记录的属性测试

    - **属性 17：错误日志完整性**
    - **验证：需求 7.1, 7.2**

  - [x] 4.3 编写调试日志可控性的属性测试

    - **属性 18：调试日志可控**
    - **验证：需求 7.3**

- [x] 5. 实现 Mermaid 解析包装器
  - [x] 5.1 实现带超时的解析函数
    - 包装 ui.parseMermaidDiagram
    - 使用 Promise 和 setTimeout 实现超时控制
    - 超时时间设置为 10 秒
    - _需求：2.1, 2.5_

  - [x] 5.2 实现解析错误处理
    - 捕获解析器抛出的异常
    - 提取错误信息和位置
    - 返回详细的错误对象
    - _需求：2.2, 7.5_

  - [x] 5.3 编写 Mermaid 解析成功的属性测试

    - **属性 6：Mermaid 解析成功**
    - **验证：需求 2.1, 2.4**

  - [x] 5.4 编写解析错误详细信息的属性测试

    - **属性 7：解析错误详细信息**
    - **验证：需求 2.2, 7.5**

  - [x] 5.5 编写不支持图表类型的单元测试

    - 测试不支持的 Mermaid 图表类型
    - 验证返回 UNSUPPORTED_TYPE 错误
    - _需求：2.3_

  - [x] 5.6 编写解析超时的单元测试

    - 测试解析超时场景
    - 验证返回 TIMEOUT 错误
    - _需求：2.5_

- [x] 6. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户


- [x] 7. 实现画布插入功能
  - [x] 7.1 实现图表插入逻辑
    - 调用 ui.importXml 插入 XML 到画布
    - 处理插入位置（默认或指定）
    - 返回插入的 cells
    - _需求：3.1, 3.2_

  - [x] 7.2 编写图表插入成功的属性测试

    - **属性 8：图表插入成功**
    - **验证：需求 3.1**

  - [x] 7.3 编写插入位置正确性的属性测试

    - **属性 9：插入位置正确**
    - **验证：需求 3.2, 5.4**

  - [x] 7.4 实现图表自动选中
    - 调用 graph.setSelectionCells 选中新插入的图表
    - 支持通过 options.select 控制是否选中
    - _需求：3.3_

  - [x] 7.5 编写图表自动选中的属性测试

    - **属性 10：图表自动选中**
    - **验证：需求 3.3**

  - [x] 7.6 实现视图自动调整
    - 调用 graph.scrollCellToVisible 确保图表可见
    - 支持通过 options.center 控制是否居中
    - _需求：3.4_

  - [x] 7.7 编写视图自动调整的属性测试

    - **属性 11：视图自动调整**
    - **验证：需求 3.4**

  - [x] 7.8 实现插入失败时的状态保护
    - 使用 try-catch 捕获插入异常
    - 确保失败时画布状态不变
    - 返回 INSERT_FAILED 错误
    - _需求：3.5_

  - [x] 7.9 编写失败时状态不变的属性测试

    - **属性 12：失败时状态不变**
    - **验证：需求 3.5**

- [x] 8. 实现缩放功能
  - [x] 8.1 实现图表缩放逻辑
    - 检查 options.scale 参数
    - 调用 graph.scaleCells 缩放图表
    - 验证缩放比例范围（0.1 - 10.0）
    - _需求：5.5_

  - [x] 8.2 编写缩放参数生效的属性测试

    - **属性 16：缩放参数生效**
    - **验证：需求 5.5**

- [x] 9. 实现主消息处理器
  - [x] 9.1 实现 handleGenerateMermaid 函数
    - 调用 validateMessage 验证消息
    - 调用解析器解析 Mermaid
    - 调用插入函数插入图表
    - 应用选项（位置、缩放、选中）
    - 标记文档为已修改
    - 发送响应消息
    - _需求：1.1, 2.1, 3.1, 4.1, 5.1_

  - [x] 9.2 实现 handleMessage 函数
    - 解析 JSON 消息
    - 识别 action 类型
    - 路由到对应的处理器
    - 保留现有的 importMermaid 和 insertMermaid 处理逻辑
    - _需求：8.1, 8.2_

  - [x] 9.3 编写端到端集成测试

    - 测试完整的消息处理流程
    - 验证成功和失败场景
    - _需求：4.5_

- [x] 10. 实现配置管理
  - [x] 10.1 实现配置对象
    - 定义 CONFIG 对象（MAX_MESSAGE_SIZE, PARSE_TIMEOUT, DEBUG_MODE, ALLOWED_ORIGINS）
    - 从 URL 参数读取配置
    - 从全局配置读取配置
    - _需求：6.1, 6.2, 7.4_

  - [x] 10.2 编写配置读取的单元测试

    - 测试从 URL 参数读取配置
    - 测试从全局配置读取配置
    - 测试默认配置
    - _需求：7.4_

- [x] 11. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户


- [x] 12. 集成到 mermaid-import.js 插件
  - [x] 12.1 修改 mermaid-import.js 文件
    - 添加配置对象
    - 添加验证器函数
    - 添加响应发送器函数
    - 添加日志记录函数
    - 添加 handleGenerateMermaid 函数
    - 修改 handleMessage 函数以支持新 action
    - 保持现有代码不变
    - _需求：8.1, 8.2_

  - [x] 12.2 编写向后兼容性测试

    - **属性 19：向后兼容性**
    - **验证：需求 8.1, 8.2**

  - [x] 12.3 运行现有测试套件

    - 验证现有功能不受影响
    - 确保 importMermaid 和 insertMermaid 仍然工作
    - _需求：8.2_

- [x] 13. 添加浏览器兼容性检查
  - [x] 13.1 实现浏览器兼容性检测
    - 检查 structuredClone 是否可用
    - 检查 Promise 是否可用
    - 不支持时返回 UNSUPPORTED_BROWSER 错误
    - _需求：8.4_

  - [x] 13.2 编写浏览器兼容性的单元测试

    - 测试不支持的浏览器场景
    - 验证降级行为
    - _需求：8.3, 8.4_

- [x] 14. 添加性能监控
  - [x] 14.1 实现性能测量函数
    - 使用 performance.now() 测量操作时间
    - 记录关键操作的耗时
    - 在调试模式下输出性能日志
    - _需求：7.3_

  - [x] 14.2 编写性能监控的单元测试

    - 测试性能测量功能
    - 验证日志输出
    - _需求：7.3_

- [x] 15. 创建前端集成示例
  - [x] 15.1 创建 HTML 示例文件
    - 创建基本的 HTML 页面
    - 添加 textarea 用于输入 Mermaid 文本
    - 添加按钮触发生成
    - 嵌入 draw.io iframe
    - 实现消息发送和接收逻辑
    - _需求：4.5_

  - [x] 15.2 创建 React 示例组件
    - 创建 React 组件
    - 使用 useRef 管理 iframe 引用
    - 使用 useEffect 监听消息
    - 实现生成图表功能
    - _需求：4.5_

  - [x] 15.3 测试前端集成示例

    - 手动测试 HTML 示例
    - 手动测试 React 示例
    - 验证端到端流程
    - _需求：4.5_

- [x] 16. 编写文档
  - [x] 16.1 创建 API 文档
    - 文档化消息格式
    - 文档化响应格式
    - 文档化错误代码
    - 文档化配置选项
    - _需求：5.1, 5.2, 5.3_

  - [x] 16.2 创建集成指南
    - 编写前端集成步骤
    - 提供代码示例
    - 说明常见问题和解决方案
    - _需求：4.5_

  - [x] 16.3 创建故障排查指南
    - 列出常见问题
    - 提供调试技巧
    - 说明如何启用调试模式
    - _需求：7.4_

- [x] 17. 最终检查点 - 确保所有测试通过
  - 运行完整的测试套件
  - 验证所有功能正常工作
  - 检查代码覆盖率（目标 80%）
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以根据需要跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 检查点任务用于确保增量进展和及时发现问题
- 所有代码修改都应该保持向后兼容性
- 测试应该使用 Jest 和 fast-check 框架
- 每个属性测试至少运行 100 次迭代
