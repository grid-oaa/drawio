# 前端集成示例测试清单

本文档提供了测试 HTML 和 React 示例的详细步骤和验证标准。

## 测试环境要求

- **浏览器**: Chrome 90+, Firefox 88+, Safari 14+, 或 Edge 90+
- **网络**: 需要互联网连接（加载 Draw.io iframe）
- **React 测试**: Node.js 14+ 和 React 16.8+

---

## 测试 1: HTML 示例基础功能测试

### 测试步骤

1. **打开 HTML 文件**
   - [ ] 在浏览器中打开 `examples/mermaid-integration.html`
   - [ ] 验证页面正常加载，无控制台错误
   - [ ] 验证 Draw.io iframe 正常显示

2. **验证初始状态**
   - [ ] 文本框中显示默认的流程图 Mermaid 代码
   - [ ] "生成图表" 和 "清空输入" 按钮可见且可点击
   - [ ] 状态区域显示 "Draw.io 已就绪" 消息（蓝色背景）
   - [ ] Draw.io iframe 显示空白画布

3. **测试基本图表生成**
   - [ ] 点击 "生成图表" 按钮
   - [ ] 等待 2-3 秒
   - [ ] 验证状态区域显示 "图表生成成功" 消息（绿色背景）
   - [ ] 验证 Draw.io 画布中出现流程图
   - [ ] 验证图表自动被选中（有选择框）

4. **测试清空功能**
   - [ ] 点击 "清空输入" 按钮
   - [ ] 验证文本框内容被清空
   - [ ] 验证状态消息消失

5. **测试示例模板**
   - [ ] 点击 "流程图" 按钮
   - [ ] 验证文本框填充流程图示例代码
   - [ ] 点击 "时序图" 按钮
   - [ ] 验证文本框内容更新为时序图代码
   - [ ] 测试其他模板按钮（类图、状态图、ER图、甘特图）

6. **测试键盘快捷键**
   - [ ] 在文本框中输入或修改 Mermaid 代码
   - [ ] 按 Ctrl+Enter (Windows/Linux) 或 Cmd+Enter (Mac)
   - [ ] 验证图表自动生成

### 预期结果

✅ **通过标准**:
- 所有按钮功能正常
- 图表成功生成并显示在画布中
- 状态消息准确反映操作结果
- 键盘快捷键工作正常
- 无控制台错误

---

## 测试 2: HTML 示例错误处理测试

### 测试步骤

1. **测试空输入**
   - [ ] 清空文本框
   - [ ] 点击 "生成图表" 按钮
   - [ ] 验证显示警告消息 "请输入 Mermaid 文本"（红色背景）
   - [ ] 验证画布无变化

2. **测试无效 Mermaid 语法**
   - [ ] 在文本框中输入无效语法：`invalid mermaid syntax!!!`
   - [ ] 点击 "生成图表" 按钮
   - [ ] 验证显示错误消息（红色背景）
   - [ ] 验证错误消息包含具体错误描述
   - [ ] 验证画布无变化

3. **测试仅空白字符**
   - [ ] 在文本框中输入多个空格和换行
   - [ ] 点击 "生成图表" 按钮
   - [ ] 验证显示警告消息
   - [ ] 验证画布无变化

### 预期结果

✅ **通过标准**:
- 所有错误情况都有适当的错误消息
- 错误消息清晰易懂
- 错误不会导致页面崩溃
- 画布状态在错误时保持不变

---

## 测试 3: HTML 示例多图表测试

### 测试步骤

1. **生成第一个图表**
   - [ ] 使用流程图示例生成图表
   - [ ] 验证图表出现在画布中

2. **生成第二个图表**
   - [ ] 切换到时序图示例
   - [ ] 点击 "生成图表"
   - [ ] 验证新图表出现在画布中
   - [ ] 验证第一个图表仍然存在

3. **生成多个不同类型的图表**
   - [ ] 依次生成类图、状态图、ER图
   - [ ] 验证所有图表都正确显示
   - [ ] 验证图表不会重叠（位置合理）

### 预期结果

✅ **通过标准**:
- 可以连续生成多个图表
- 新图表不会覆盖旧图表
- 所有图表类型都能正确渲染
- 画布可以容纳多个图表

---

## 测试 4: React 组件集成测试

### 前置条件

创建一个简单的 React 测试应用：

```bash
# 创建测试目录
mkdir -p examples/react-test
cd examples/react-test

# 初始化 React 应用（如果需要）
npx create-react-app . --template minimal

# 或者使用现有的 React 项目
```

### 测试步骤

1. **集成组件**
   - [ ] 将 `DrawioMermaidIntegration.jsx` 复制到 React 项目
   - [ ] 在 App.js 中导入并使用组件
   - [ ] 运行 `npm start`
   - [ ] 验证应用启动无错误

2. **验证组件渲染**
   - [ ] 打开浏览器访问 React 应用
   - [ ] 验证组件正常渲染
   - [ ] 验证所有 UI 元素显示正确
   - [ ] 验证 Draw.io iframe 加载

3. **测试基本功能**
   - [ ] 测试生成图表功能
   - [ ] 测试清空输入功能
   - [ ] 测试示例模板加载
   - [ ] 测试键盘快捷键

4. **测试状态管理**
   - [ ] 验证状态消息正确更新
   - [ ] 验证 iframe 就绪状态正确跟踪
   - [ ] 验证文本框内容与 state 同步

5. **测试 React 特性**
   - [ ] 验证组件可以重新渲染而不丢失状态
   - [ ] 验证 useEffect 清理函数正常工作
   - [ ] 验证 useRef 正确引用 iframe

### 预期结果

✅ **通过标准**:
- 组件成功集成到 React 应用
- 所有功能与 HTML 版本一致
- React 状态管理正常
- 无 React 警告或错误
- 组件可以正常卸载和重新挂载

---

## 测试 5: 端到端流程验证

### 测试场景 1: 完整的用户工作流

1. **用户打开页面**
   - [ ] 页面加载
   - [ ] iframe 初始化
   - [ ] 显示就绪消息

2. **用户浏览示例**
   - [ ] 点击不同的示例按钮
   - [ ] 查看不同的 Mermaid 代码

3. **用户生成图表**
   - [ ] 选择一个示例
   - [ ] 点击生成按钮
   - [ ] 图表出现在画布

4. **用户修改和重新生成**
   - [ ] 修改 Mermaid 代码
   - [ ] 重新生成图表
   - [ ] 新图表正确显示

5. **用户处理错误**
   - [ ] 输入错误语法
   - [ ] 看到错误消息
   - [ ] 修正错误
   - [ ] 成功生成图表

### 测试场景 2: 消息通信验证

1. **验证消息发送**
   - [ ] 打开浏览器开发者工具
   - [ ] 切换到 Console 标签
   - [ ] 生成图表
   - [ ] 验证控制台显示 "Diagram generated successfully" 日志
   - [ ] 验证日志包含响应数据

2. **验证消息接收**
   - [ ] 在控制台中手动发送消息：
     ```javascript
     document.getElementById('drawio-iframe').contentWindow.postMessage(
       JSON.stringify({
         action: 'generateMermaid',
         mermaid: 'flowchart TD\n    A --> B'
       }),
       '*'
     );
     ```
   - [ ] 验证图表生成
   - [ ] 验证收到响应消息

3. **验证错误响应**
   - [ ] 发送无效消息
   - [ ] 验证收到错误响应
   - [ ] 验证错误消息包含 errorCode

### 预期结果

✅ **通过标准**:
- 完整的用户流程顺畅无阻
- 消息通信双向正常
- 错误处理机制有效
- 用户体验良好

---

## 测试 6: 浏览器兼容性测试

### 测试步骤

在以下浏览器中重复测试 1-3：

1. **Chrome/Edge (Chromium)**
   - [ ] 测试基本功能
   - [ ] 测试错误处理
   - [ ] 测试多图表生成

2. **Firefox**
   - [ ] 测试基本功能
   - [ ] 测试错误处理
   - [ ] 测试多图表生成

3. **Safari** (如果可用)
   - [ ] 测试基本功能
   - [ ] 测试错误处理
   - [ ] 测试多图表生成

### 预期结果

✅ **通过标准**:
- 所有浏览器中功能一致
- 无浏览器特定的错误
- UI 在所有浏览器中正常显示

---

## 测试 7: 性能和稳定性测试

### 测试步骤

1. **快速连续生成**
   - [ ] 快速点击生成按钮 10 次
   - [ ] 验证所有请求都被处理
   - [ ] 验证无内存泄漏
   - [ ] 验证页面响应正常

2. **大型图表测试**
   - [ ] 输入包含 50+ 节点的复杂流程图
   - [ ] 生成图表
   - [ ] 验证生成成功
   - [ ] 验证性能可接受（< 10 秒）

3. **长时间运行测试**
   - [ ] 保持页面打开 30 分钟
   - [ ] 期间生成 20+ 个图表
   - [ ] 验证无性能下降
   - [ ] 验证无内存泄漏

### 预期结果

✅ **通过标准**:
- 快速操作不会导致错误
- 大型图表可以正常处理
- 长时间运行稳定
- 无明显的性能问题

---

## 测试结果记录

### HTML 示例测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 基础功能 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| 错误处理 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| 多图表 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| 端到端 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| 浏览器兼容 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| 性能稳定性 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |

### React 组件测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 组件集成 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| 基础功能 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| 状态管理 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |
| React 特性 | ⬜ 未测试 / ✅ 通过 / ❌ 失败 | |

### 发现的问题

1. **问题描述**: 
   - **严重程度**: 高 / 中 / 低
   - **复现步骤**: 
   - **预期行为**: 
   - **实际行为**: 
   - **解决方案**: 

---

## 测试完成标准

要完成此任务，必须满足以下条件：

- [ ] HTML 示例的所有基础功能测试通过
- [ ] HTML 示例的错误处理测试通过
- [ ] HTML 示例可以生成多个不同类型的图表
- [ ] React 组件可以成功集成并运行
- [ ] React 组件的所有功能与 HTML 版本一致
- [ ] 端到端流程验证通过
- [ ] 至少在 2 个不同浏览器中测试通过
- [ ] 无严重或阻塞性问题
- [ ] 所有发现的问题都已记录

---

## 附录：手动测试命令

### 在浏览器控制台中测试消息通信

```javascript
// 获取 iframe 引用
const iframe = document.getElementById('drawio-iframe');

// 发送测试消息
iframe.contentWindow.postMessage(JSON.stringify({
  action: 'generateMermaid',
  mermaid: 'flowchart TD\n    A[测试] --> B[成功]',
  options: {
    position: { x: 100, y: 100 },
    select: true
  }
}), '*');

// 监听响应
window.addEventListener('message', (evt) => {
  console.log('Received message:', evt.data);
});
```

### 测试错误场景

```javascript
// 测试空 mermaid
iframe.contentWindow.postMessage(JSON.stringify({
  action: 'generateMermaid',
  mermaid: ''
}), '*');

// 测试无效语法
iframe.contentWindow.postMessage(JSON.stringify({
  action: 'generateMermaid',
  mermaid: 'invalid syntax!!!'
}), '*');

// 测试缺少字段
iframe.contentWindow.postMessage(JSON.stringify({
  action: 'generateMermaid'
}), '*');
```

---

## 需求验证

此测试清单验证以下需求：

- **需求 4.5**: 前端系统能够接收到 draw.io 的处理结果反馈
  - ✅ 测试 1-2 验证成功和错误响应
  - ✅ 测试 5 验证端到端消息通信

---

**测试人员**: _________________  
**测试日期**: _________________  
**测试环境**: _________________  
**总体结论**: ⬜ 通过 / ⬜ 有问题但可接受 / ⬜ 失败
